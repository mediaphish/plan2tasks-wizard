<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Review</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:12px 0; }
    input, select, button { font-size:14px; padding:6px 10px; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { padding:8px; border-bottom:1px solid #e5e7eb; text-align:left; vertical-align:top; }
    .meta { color:#6b7280; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Review Bundle</h1>

    <div class="row">
      <div id="bundleTitle" style="font-weight:600;">—</div>
      <div class="meta" id="bundleMeta">Start: — • Timezone: America/Chicago</div>
    </div>

    <div class="row">
      <label for="mode">Push mode:</label>
      <select id="mode">
        <option value="append" selected>append</option>
        <option value="replace">replace</option>
      </select>

      <label for="listTitle">List title:</label>
      <input id="listTitle" type="text" placeholder="Plan: —" />

      <label for="userEmail">User:</label>
      <input id="userEmail" type="email" placeholder="user@example.com" />

      <button id="btnPush">Push</button>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:22%;">Date (YYYY-MM-DD)</th>
          <th style="width:12%;">Time (HH:MM)</th>
          <th style="width:12%;">Duration</th>
          <th>Title</th>
          <th style="width:28%;">Notes</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="5">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <script defer>
    (function () {
      // Defaults per your rules
      var plannerEmail = "bartpaden@gmail.com";
      var defaultUserEmail = "bart@midwesternbuilt.com";
      var defaultTimezone = "America/Chicago";

      function $(id){ return document.getElementById(id); }
      var els = {
        title: $("bundleTitle"),
        meta: $("bundleMeta"),
        tbody: $("tbody"),
        mode: $("mode"),
        listTitle: $("listTitle"),
        userEmail: $("userEmail"),
        btnPush: $("btnPush")
      };

      function pad(n){ return String(n).padStart(2, '0'); }
      function addDays(yyyyMmDd, offsetDays){
        var parts = (yyyyMmDd || "").split("-");
        var y = parseInt(parts[0], 10), m = parseInt(parts[1], 10), d = parseInt(parts[2], 10);
        if (!y || !m || !d) return "";
        var dt = new Date(y, m - 1, d);
        dt.setDate(dt.getDate() + Number(offsetDays || 0));
        return dt.getFullYear() + "-" + pad(dt.getMonth() + 1) + "-" + pad(dt.getDate());
      }
      function hhmm(t){
        if (t === null || t === undefined || t === "") return "";
        var s = String(t);
        return s.length >= 5 ? s.slice(0,5) : s;
      }

      // Safe getters to handle different shapes/keys
      function firstKey(obj, keys) {
        if (!obj) return undefined;
        for (var i=0; i<keys.length; i++){
          if (Object.prototype.hasOwnProperty.call(obj, keys[i])) return obj[keys[i]];
        }
        return undefined;
      }

      function normalizeBundleShape(body) {
        var root = body || {};
        var data = firstKey(root, ["data"]) || root;
        var bundle = firstKey(data, ["bundle", "inbox", "record"]) || data;

        var tasks = firstKey(data, ["tasks", "items"]);
        if (!Array.isArray(tasks)) {
          tasks = firstKey(bundle, ["tasks", "items"]);
        }
        if (!Array.isArray(tasks)) tasks = [];

        return {
          title: firstKey(bundle, ["title"]) || "",
          startDate: firstKey(bundle, ["start_date", "startDate"]) || "",
          timezone: firstKey(bundle, ["timezone"]) || defaultTimezone,
          userEmail: firstKey(bundle, ["userEmail", "suggested_user", "assigned_user"]) || "",
          tasks: tasks
        };
      }

      function normalizeTasks(tasks, startDate){
        return (tasks || []).map(function (t) {
          var offset = undefined;
          if (Object.prototype.hasOwnProperty.call(t, "dayOffset")) offset = t.dayOffset;
          else if (Object.prototype.hasOwnProperty.call(t, "day_offset")) offset = t.day_offset;

          var date = t.date || (offset !== undefined ? addDays(startDate, offset) : "");
          var durationMins = null;
          if (Object.prototype.hasOwnProperty.call(t, "durationMins")) durationMins = t.durationMins;
          else if (Object.prototype.hasOwnProperty.call(t, "duration_mins")) durationMins = t.duration_mins;
          else if (Object.prototype.hasOwnProperty.call(t, "minutes")) durationMins = t.minutes;

          var time = firstKey(t, ["time", "start_time", "at"]);
          var notes = firstKey(t, ["notes", "note", "description"]) || "";

          return {
            title: t.title || "",
            date: date,
            time: hhmm(time),
            durationMins: durationMins,
            notes: notes
          };
        });
      }

      function renderTasks(rows){
        if (!rows || !rows.length){
          els.tbody.innerHTML = '<tr><td colspan="5">No tasks.</td></tr>';
          return;
        }
        var html = rows.map(function (r) {
          return '<tr>'
            + '<td>' + (r.date || "") + '</td>'
            + '<td>' + (r.time || "") + '</td>'
            + '<td>' + (r.durationMins ? (r.durationMins + " mins") : "") + '</td>'
            + '<td>' + (r.title || "") + '</td>'
            + '<td>' + (r.notes || "") + '</td>'
            + '</tr>';
        }).join('');
        els.tbody.innerHTML = html;
      }

      function getInboxId() {
        var q = new URLSearchParams(window.location.search || "");
        return q.get("inboxId") || q.get("id") || "";
      }

      function loadBundle(){
        var inboxId = getInboxId();
        if (!inboxId) {
          els.tbody.innerHTML = '<tr><td colspan="5">Missing inboxId.</td></tr>';
          return;
        }

        var url = '/api/inbox/get?inboxId=' + encodeURIComponent(inboxId) + '&plannerEmail=' + encodeURIComponent(plannerEmail);
        fetch(url)
          .then(function (r) { return r.json().catch(function(){ return {}; }).then(function (b){ return { ok:r.ok, status:r.status, body:b }; }); })
          .then(function (resp){
            if (!resp.ok) {
              els.tbody.innerHTML = '<tr><td colspan="5">Failed to load.</td></tr>';
              return;
            }
            var b = normalizeBundleShape(resp.body);

            // Cache-like locals (kept simple; no global state)
            var title = b.title || "—";
            var startDate = b.startDate || "";
            var tz = b.timezone || defaultTimezone;
            var userEmail = b.userEmail || defaultUserEmail;

            els.title.textContent = title;
            els.meta.textContent = 'Start: ' + (startDate || '—') + ' • Timezone: ' + tz;
            els.listTitle.placeholder = 'Plan: ' + title;
            els.userEmail.value = userEmail;

            var rows = normalizeTasks(b.tasks, b.startDate);
            renderTasks(rows);

            // Attach push handler now that we have meta
            els.btnPush.onclick = function pushBundle(){
              // Re-read visible table to guarantee absolute dates only
              var trs = Array.prototype.slice.call(els.tbody.querySelectorAll('tr'));
              var items = trs.map(function (tr) {
                var tds = tr.querySelectorAll('td');
                if (tds.length < 5) return null;
                var date = (tds[0].textContent || "").trim();
                var time = (tds[1].textContent || "").trim() || null;
                var durTxt = (tds[2].textContent || "").trim();
                var titleCell = (tds[3].textContent || "").trim();
                var notes = (tds[4].textContent || "").trim();
                var durationMins = durTxt ? parseInt(durTxt.replace(/\D+/g,''),10) : null;
                return { title: titleCell, date: date, time: time, durationMins: durationMins, notes: notes };
              }).filter(Boolean);

              if (items.some(function (it){ return !it.date; })) {
                // Abort silently if any row lacks a date
                return;
              }

              var payload = {
                plannerEmail: plannerEmail,
                userEmail: (els.userEmail.value || defaultUserEmail).trim(),
                listTitle: (els.listTitle.value || els.listTitle.placeholder || ('Plan: ' + title)).trim(),
                timezone: tz,
                startDate: startDate,
                mode: (els.mode.value === 'replace' ? 'replace' : 'append'),
                items: items
              };

              fetch('/api/push', {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify(payload)
              }).catch(function(){ /* silent per your rule */ });
            };
          })
          .catch(function (){
            els.tbody.innerHTML = '<tr><td colspan="5">Failed to load.</td></tr>';
          });
      }

      document.addEventListener('DOMContentLoaded', loadBundle);
    })();
  </script>
</body>
</html>
