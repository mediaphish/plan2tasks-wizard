<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plan2Tasks · Review</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-100 text-gray-900">
  <div class="mx-auto max-w-5xl p-4">
    <!-- Header -->
    <div class="mb-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="text-xl sm:text-2xl font-bold">Plan2Tasks</div>
        <span class="text-xs text-gray-500">Review &amp; Push</span>
      </div>
      <a href="/inbox.html" class="rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs sm:text-sm hover:bg-gray-50">Inbox</a>
    </div>

    <!-- Controls -->
    <div class="mb-4 grid gap-2 sm:grid-cols-2">
      <div class="rounded-xl border border-gray-300 bg-white p-3">
        <label class="block text-xs text-gray-500 mb-1">Planner</label>
        <input id="planner" class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm"
               placeholder="Planner email" />
      </div>
      <div class="rounded-xl border border-gray-300 bg-white p-3">
        <label class="block text-xs text-gray-500 mb-1">Assigned User</label>
        <select id="user" class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm"></select>
      </div>
    </div>

    <!-- Bundle panel -->
    <div class="rounded-xl border border-gray-300 bg-white p-4 mb-3">
      <div class="flex items-center justify-between gap-3">
        <div class="font-semibold text-base" id="btitle">(loading…)</div>
        <div class="text-xs text-gray-600">
          <span id="bmeta" class="mr-2"></span>
          <span class="rounded-full border border-gray-300 bg-gray-50 px-2 py-[2px] text-[11px]" id="bcount">0 tasks</span>
        </div>
      </div>
      <div class="mt-2 text-xs text-gray-600" id="bdesc"></div>
    </div>

    <!-- Tasks table -->
    <div class="rounded-xl border border-gray-300 bg-white p-2">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-xs text-gray-500">
            <th class="px-2 py-2">Task</th>
            <th class="px-2 py-2">Day Offset</th>
            <th class="px-2 py-2">Time</th>
            <th class="px-2 py-2">Duration</th>
            <th class="px-2 py-2">Notes</th>
          </tr>
        </thead>
      </table>
      <div id="rows" class="divide-y divide-gray-200"></div>
    </div>

    <!-- Action bar -->
    <div class="mt-4 flex flex-wrap items-center gap-2">
      <label class="text-xs text-gray-500">List Title</label>
      <input id="listTitle" class="rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm w-64" placeholder="e.g. Weekly Plan" />
      <label class="text-xs text-gray-500 ml-2">Mode</label>
      <select id="mode" class="rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm">
        <option value="append">Append</option>
        <option value="replace">Replace</option>
      </select>
      <button id="pushBtn" class="ml-auto rounded-xl bg-indigo-600 text-white px-4 py-2 text-sm">Push to User</button>
    </div>

    <!-- Status -->
    <div id="status" class="mt-3 text-sm text-gray-700"></div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const plannerInput = $('#planner');
    const userSelect   = $('#user');
    const btitle = $('#btitle');
    const bmeta  = $('#bmeta');
    const bcount = $('#bcount');
    const bdesc  = $('#bdesc');
    const rows   = $('#rows');
    const pushBtn= $('#pushBtn');
    const listTitle = $('#listTitle');
    const modeSel   = $('#mode');
    const statusEl  = $('#status');

    const qs = new URLSearchParams(location.search);
    const inboxId = qs.get('inboxId') || '';
    const state = {
      plannerEmail: localStorage.getItem('p2t:plannerEmail') || 'bartpaden@gmail.com',
      bundle: null,
      tasks: [],
      users: []
    };
    plannerInput.value = state.plannerEmail;

    plannerInput.addEventListener('change', () => {
      state.plannerEmail = plannerInput.value.trim().toLowerCase();
      localStorage.setItem('p2t:plannerEmail', state.plannerEmail);
      reload();
    });

    async function getJSON(url){
      const r = await fetch(url, { credentials: 'include' });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || j.ok === false){ throw new Error(j.error || ('HTTP '+r.status)); }
      return j;
    }
    async function postJSON(url, body){
      const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || j.ok === false){ throw new Error(j.error || ('HTTP '+r.status)); }
      return j;
    }
    function esc(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    async function loadUsers(){
      const url = `/api/users?op=list&plannerEmail=${encodeURIComponent(state.plannerEmail)}&status=all`;
      const j = await getJSON(url);
      state.users = (j.users||[]);
      userSelect.innerHTML = '';
      for(const u of state.users){
        const opt = document.createElement('option');
        opt.value = u.email;
        opt.textContent = u.email;
        userSelect.appendChild(opt);
      }
    }

    function renderBundle(){
      const b = state.bundle;
      btitle.textContent = b.title || '(untitled)';
      bmeta.textContent  = `Start ${b.startDate} • ${b.timezone}`;
      bcount.textContent = `${state.tasks.length} tasks`;
      bdesc.textContent  = b.assigned_user ? `Assigned to ${b.assigned_user}` :
                           b.suggested_user ? `Suggested: ${b.suggested_user}` : 'Unassigned';

      rows.innerHTML = '';
      for(const t of state.tasks){
        const row = document.createElement('div');
        row.className = 'grid grid-cols-1 sm:grid-cols-5 text-sm';
        row.innerHTML = `
          <div class="px-2 py-2">${esc(t.title)}</div>
          <div class="px-2 py-2">${t.dayOffset ?? 0}</div>
          <div class="px-2 py-2">${t.time || ''}</div>
          <div class="px-2 py-2">${t.durationMins || 60} min</div>
          <div class="px-2 py-2">${esc(t.notes || '')}</div>
        `;
        rows.appendChild(row);
      }
      // Defaults for push
      listTitle.value = (b.title ? `Plan: ${b.title}` : 'Weekly Plan');
      // preselect user: assigned_user > suggested_user > first in list
      setTimeout(() => {
        userSelect.value = b.assigned_user || b.suggested_user || (state.users[0]?.email || '');
      }, 0);
    }

    async function reload(){
      statusEl.textContent = 'Loading…';
      try{
        await loadUsers();
        const url = `/api/inbox/get?plannerEmail=${encodeURIComponent(state.plannerEmail)}&inboxId=${encodeURIComponent(inboxId)}`;
        const j = await getJSON(url);
        state.bundle = {
          id: j.bundle.id,
          title: j.bundle.title,
          startDate: j.bundle.startDate,
          timezone: j.bundle.timezone,
          assigned_user: j.bundle.assigned_user || null,
          suggested_user: j.bundle.suggested_user || null
        };
        state.tasks = j.tasks || [];
        renderBundle();
        statusEl.textContent = '';
      }catch(e){
        statusEl.textContent = 'Error: ' + (e.message || e);
      }
    }

    pushBtn.addEventListener('click', async () => {
      const b = state.bundle;
      const userEmail = userSelect.value || '';
      if(!userEmail){ alert('Choose a user'); return; }
      try{
        statusEl.textContent = 'Pushing…';
        await postJSON('/api/push', {
          plannerEmail: state.plannerEmail,
          userEmail,
          listTitle: listTitle.value || 'Weekly Plan',
          timezone: b.timezone,
          startDate: b.startDate,
          mode: modeSel.value,       // "append" or "replace"
          items: state.tasks         // already shaped for /api/push
        });
        statusEl.textContent = '✅ Pushed to Google Tasks';
      }catch(e){
        statusEl.textContent = 'Push failed: ' + (e.message || e);
      }
    });

    // boot
    if(!inboxId){
      statusEl.textContent = 'Missing inboxId in the URL.';
    }else{
      reload();
    }
  </script>
</body>
</html>
