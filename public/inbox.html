<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plan2Tasks · Inbox</title>
  <!-- Tailwind CDN to mirror your app’s utility classes -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Helvetica','Arial','sans-serif']
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen bg-gray-100 text-gray-900">
  <div class="mx-auto max-w-6xl p-4">
    <!-- Header -->
    <div class="mb-3 sm:mb-6 flex flex-wrap items-center justify-between gap-2">
      <div class="flex items-center gap-2 sm:gap-3">
        <div class="text-lg sm:text-2xl font-bold whitespace-nowrap">Plan2Tasks</div>
        <span id="version" class="text-[10px] sm:text-xs text-gray-500 whitespace-nowrap select-none ml-1 sm:ml-2">Inbox</span>
      </div>
      <div class="relative">
        <button class="relative rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs sm:text-sm hover:bg-gray-50">
          Inbox
          <span id="badge" class="absolute -top-2 -right-2 rounded-full bg-indigo-600 text-white px-1.5 py-[2px] text-[10px] font-bold hidden">0</span>
        </button>
      </div>
    </div>

    <!-- Controls -->
    <div class="mb-3 sm:mb-4 flex flex-wrap items-center gap-2">
      <input id="planner" class="rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs sm:text-sm w-72"
             placeholder="Planner email" />
      <input id="search" class="rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs sm:text-sm w-60"
             placeholder="Filter by title…" />
      <button id="refresh" class="rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs sm:text-sm hover:bg-gray-50">
        Refresh
      </button>
    </div>

    <!-- List -->
    <div id="list" class="grid gap-2"></div>

    <!-- Empty state -->
    <div id="empty" class="rounded-xl border border-dashed border-gray-300 bg-white px-4 py-6 text-center text-sm text-gray-600 hidden">
      No new bundles. When GPT sends a bundle, it will appear here automatically.
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const plannerInput = $('#planner');
    const searchInput  = $('#search');
    const listEl       = $('#list');
    const emptyEl      = $('#empty');
    const badgeEl      = $('#badge');
    const refreshBtn   = $('#refresh');

    const state = {
      plannerEmail: localStorage.getItem('p2t:plannerEmail') || 'bartpaden@gmail.com',
      items: [],
      timer: null
    };
    plannerInput.value = state.plannerEmail;

    plannerInput.addEventListener('change', () => {
      state.plannerEmail = (plannerInput.value || '').trim().toLowerCase();
      localStorage.setItem('p2t:plannerEmail', state.plannerEmail);
      fetchAndRender();
    });
    searchInput.addEventListener('input', render);
    refreshBtn.addEventListener('click', fetchAndRender);

    async function getJSON(url){
      const res = await fetch(url, { credentials: 'include' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    }
    function fmtDate(iso){
      const d = new Date(iso);
      return d.toLocaleString(undefined,{ month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function render(){
      const q = (searchInput.value||'').toLowerCase().trim();
      const data = q ? state.items.filter(x => (x.title||'').toLowerCase().includes(q)) : state.items;

      listEl.innerHTML = '';
      if(!data.length){
        emptyEl.classList.remove('hidden');
        badgeEl.classList.add('hidden');
        return;
      }
      emptyEl.classList.add('hidden');
      badgeEl.textContent = String(data.length);
      badgeEl.classList.remove('hidden');

      for(const b of data){
        const card = document.createElement('div');
        card.className = 'rounded-xl border border-gray-300 bg-white p-3 sm:p-4 flex items-start justify-between gap-3';

        const left = document.createElement('div');
        left.className = 'flex-1';
        left.innerHTML = `
          <div class="font-semibold text-sm sm:text-base">${escapeHtml(b.title || '(untitled)')}</div>
          <div class="mt-1 flex flex-wrap items-center gap-3 text-xs text-gray-600">
            <span>Created ${fmtDate(b.created_at)}</span>
            <span class="text-gray-400">•</span>
            <span>Bundle ${escapeHtml(b.id.slice(0,8))}…</span>
            ${b.suggested_user ? `<span class="text-gray-400">•</span><span>Suggested: ${escapeHtml(b.suggested_user)}</span>` : ``}
            <span class="ml-1 rounded-full border border-gray-300 bg-gray-50 px-2 py-[2px] text-[11px]">${b.count || 0} tasks</span>
          </div>
        `;

        const actions = document.createElement('div');
        actions.className = 'flex items-center gap-2';

        const assignBtn = document.createElement('button');
        assignBtn.className = 'rounded-xl bg-indigo-600 text-white px-3 py-2 text-xs sm:text-sm';
        assignBtn.textContent = b.suggested_user ? `Assign to ${b.suggested_user}` : 'Assign…';
        assignBtn.onclick = () => onAssign(b);

        const reviewBtn = document.createElement('button');
        reviewBtn.className = 'rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs sm:text-sm hover:bg-gray-50';
        reviewBtn.textContent = 'Review';
        reviewBtn.onclick = () => onReview(b);

        const archiveBtn = document.createElement('button');
        archiveBtn.className = 'rounded-xl border border-gray-300 bg-white px-3 py-2 text-xs sm:text-sm text-gray-600 hover:bg-gray-50';
        archiveBtn.textContent = 'Archive';
        archiveBtn.onclick = () => onArchive(b);

        actions.append(assignBtn, reviewBtn, archiveBtn);
        card.append(left, actions);
        listEl.append(card);
      }
    }

    async function fetchAndRender(){
      if(!state.plannerEmail){
        listEl.innerHTML=''; emptyEl.classList.remove('hidden'); badgeEl.classList.add('hidden'); return;
      }
      try{
        const url = `/api/inbox?plannerEmail=${encodeURIComponent(state.plannerEmail)}&status=new`;
        const j = await getJSON(url);
        state.items = (j && j.bundles) ? j.bundles : [];
        render();
      }catch(e){
        listEl.innerHTML = `<div class="rounded-xl border border-gray-300 bg-white px-4 py-6 text-center text-sm text-red-600">Could not load inbox (${e.message}).</div>`;
        badgeEl.classList.add('hidden');
      }
    }

    async function onAssign(b){
      const user = b.suggested_user || prompt('Assign to user email:');
      if(!user) return;
      try{
        const res = await fetch('/api/inbox/assign', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ plannerEmail: state.plannerEmail, bundleId: b.id, userEmail: user })
        });
        const j = await res.json().catch(()=>({}));
        if(!res.ok || !j || j.ok === false){ throw new Error((j && j.error) || 'Assign failed'); }
        // optimistic remove
        state.items = state.items.filter(x => x.id !== b.id);
        render();
      }catch(e){
        alert('Assign failed: ' + (e.message || e));
      }
    }

    function onReview(b){
      try{
        // Persist for SPA pickup AND navigate to the planning view
        localStorage.setItem('p2t:selectedBundleId', b.id);
        const url = new URL(window.location.origin + '/');
        url.searchParams.set('view','plan');
        url.searchParams.set('bundleId', b.id);
        window.location.assign(url.toString());
      }catch{
        // Fallback: just navigate
        window.location.assign('/?view=plan&bundleId=' + encodeURIComponent(b.id));
      }
    }

    async function onArchive(b){
      if(!confirm('Archive this bundle?')) return;
      try{
        const res = await fetch('/api/inbox/archive', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ plannerEmail: state.plannerEmail, bundleId: b.id })
        });
        const j = await res.json().catch(()=>({}));
        if(!res.ok || j.ok === false) throw new Error((j && j.error) || 'Archive failed');
        state.items = state.items.filter(x => x.id !== b.id);
        render();
      }catch(e){
        alert('Archive failed: ' + (e.message || e));
      }
    }

    // Initial load + light polling so new GPT bundles pop in automatically
    fetchAndRender();
    state.timer = setInterval(fetchAndRender, 15000);
  </script>
</body>
</html>
