<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Inbox — Plan2Tasks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Logic-only: reduce stale cache without altering visuals -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <style>
    /* No visual/layout changes: keep default browser styles */
    table { border-collapse: collapse; }
    th, td { border: 1px solid #000; padding: 6px; }
  </style>
</head>
<body>
  <!-- Preserve existing simple structure: status line + table -->
  <p id="statusLine">Loading…</p>

  <table id="bundleTable">
    <thead>
      <tr>
        <th>Title</th>
        <th>Start Date</th>
        <th>Timezone</th>
        <th>Suggested User</th>
        <th>Assigned User</th>
        <th>Assigned At</th>
        <th>Archived At</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="bundleTbody"><!-- rows injected --></tbody>
  </table>

  <script>
    // Fixed planner; only showing ASSIGNED (no new UI added)
    const plannerEmail = 'bartpaden@gmail.com';
    const statusLine = document.getElementById('statusLine');
    const tbody = document.getElementById('bundleTbody');

    async function fetchJSON(url) {
      const sep = url.includes('?') ? '&' : '?';
      const noCacheUrl = `${url}${sep}t=${Date.now()}`; // cache-bust without UI change
      const res = await fetch(noCacheUrl, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function td(text) {
      const el = document.createElement('td');
      el.textContent = text ?? '';
      return el;
    }

    function linkCell(href, label) {
      const el = document.createElement('td');
      const a = document.createElement('a');
      a.href = href;
      a.textContent = label;
      el.appendChild(a);
      return el;
    }

    function isoOrEmpty(val) {
      if (!val) return '';
      try {
        // leave YYYY-MM-DD alone, otherwise keep ISO
        if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
        const d = new Date(val);
        return isNaN(d.getTime()) ? (val || '') : d.toISOString();
      } catch { return val || ''; }
    }

    function row(b) {
      const tr = document.createElement('tr');
      tr.appendChild(td(b.title || ''));
      tr.appendChild(td(b.start_date || b.startDate || ''));
      tr.appendChild(td(b.timezone || ''));
      tr.appendChild(td(b.suggested_user || ''));
      tr.appendChild(td(b.assigned_user_email || b.assigned_user || ''));
      tr.appendChild(td(isoOrEmpty(b.assigned_at)));
      tr.appendChild(td(isoOrEmpty(b.archived_at)));
      tr.appendChild(linkCell(`/review.html?inboxId=${encodeURIComponent(b.id)}`, 'Review'));
      return tr;
    }

    async function loadAssigned() {
      statusLine.textContent = 'Loading assigned bundles…';
      tbody.innerHTML = '';
      const listUrl = `/api/inbox?status=assigned&plannerEmail=${encodeURIComponent(plannerEmail)}`;
      try {
        const data = await fetchJSON(listUrl);
        const bundles = Array.isArray(data.bundles) ? data.bundles : [];
        if (bundles.length === 0) {
          statusLine.textContent = 'No assigned bundles.';
          return;
        }
        for (const b of bundles) tbody.appendChild(row(b));
        statusLine.textContent = `${bundles.length} assigned bundle(s).`;
      } catch (e) {
        statusLine.textContent = `Error loading assigned bundles: ${e.message}`;
      }
    }

    // Initial load
    loadAssigned();

    // Logic-only refreshes:
    // 1) If user returns via BFCache (back/redirect), force a reload
    window.addEventListener('pageshow', (e) => {
      if (e.persisted) location.reload();
    });
    // 2) If tab becomes visible again, re-fetch data (no UI changes)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) loadAssigned();
    });
  </script>
</body>
</html>
